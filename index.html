<script>
let valorTotal = 0;

// Tabelas de CIP
const cipResidencial = [
  {max:30, pct:0.0072},{max:100, pct:0.0107},{max:150, pct:0.0252},
  {max:200, pct:0.0268},{max:250, pct:0.0284},{max:350, pct:0.0669},
  {max:400, pct:0.0671},{max:500, pct:0.0682},{max:800, pct:0.1387},
  {max:1000, pct:0.1905},{max:2000, pct:0.3466},{max:Infinity, pct:0.3590}
];

const cipNaoResidencial = [
  {max:30, pct:0.0116},{max:100, pct:0.0259},{max:150, pct:0.0663},
  {max:200, pct:0.0682},{max:250, pct:0.0691},{max:350, pct:0.1638},
  {max:400, pct:0.1652},{max:500, pct:0.1654},{max:800, pct:0.3671},
  {max:1000, pct:0.3772},{max:2000, pct:0.7750},{max:Infinity, pct:0.8549}
];

function obterCIP(consumo, classe) {
  const tabela = classe === "residencial" ? cipResidencial : cipNaoResidencial;
  return tabela.find(f => consumo <= f.max).pct;
}

function calcular() {
  const consumo = parseFloat(document.getElementById("consumo").value) || 0;
  const classe = document.getElementById("classe").value;

  if (!classe || consumo <= 0) {
    alert("Preencha todos os campos corretamente.");
    return;
  }

  const tarifaTE = 0.32165;
  const tarifaTUSD = 0.60988;
  const adcBandeira = 0.10333;

  let valorEnergia = consumo * (tarifaTE + tarifaTUSD + adcBandeira);

  let pctCIP = obterCIP(consumo, classe);
  let valorCIP = valorEnergia * pctCIP;

  valorTotal = valorEnergia + valorCIP;

  let desconto = valorTotal >= 1000 ? 0.20 : valorTotal >= 300 ? 0.15 : 0;
  let valorFinal = valorTotal * (1 - desconto);

  document.getElementById("resultado").innerHTML = `
    <p><strong>Classe:</strong> ${classe.toUpperCase()}</p>
    <p><strong>Valor da Energia:</strong> R$ ${valorEnergia.toFixed(2)}</p>
    <p><strong>CIP (${(pctCIP*100).toFixed(2)}%):</strong> R$ ${valorCIP.toFixed(2)}</p>
    <p><strong>Fatura estimada:</strong> R$ ${valorTotal.toFixed(2)}</p>
    <p><strong>Fatura com desconto:</strong> R$ ${valorFinal.toFixed(2)}</p>
  `;

  document.getElementById("btnWhatsApp").style.display = valorTotal > 300 ? "block" : "none";
  document.getElementById("aviso").textContent =
    valorTotal <= 300 ? "⚠️ Faturas abaixo de R$ 300 não aderem ao desconto." : "";
}

function enviarWhatsApp() {
  const texto = encodeURIComponent(document.getElementById("resultado").innerText);
  window.open(`https://wa.me/5585999416424?text=${texto}`, "_blank");
}
</script>
